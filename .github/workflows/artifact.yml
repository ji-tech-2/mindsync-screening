name: Artifact

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/mindsync-model-flask

jobs:
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run tests with coverage
        run: |
          pytest --cov=flaskr --cov-report=term-missing --cov-report=xml --cov-fail-under=80 | tee coverage_output.txt

      - name: Code quality analysis
        run: |
          pylint flaskr --rcfile=.pylintrc --fail-under=8.0 | tee pylint_output.txt

      - name: Complexity analysis
        run: |
          radon cc flaskr -a -nb --total-average | tee radon_output.txt

      - name: Security scan
        run: |
          bandit -r flaskr -ll -f screen | tee bandit_output.txt

      - name: Style and formatting checks
        run: |
          black --check --diff flaskr tests *.py
          flake8 flaskr tests --config=.flake8 --statistics | tee flake8_output.txt

      - name: Check code duplication
        run: |
          pylint flaskr --disable=all --enable=duplicate-code --rcfile=.pylintrc > duplication_output.txt 2>&1 || true

      - name: Parse and display quality metrics
        if: always()
        run: |
          echo "## ðŸ“Š Quality Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Parse coverage percentage
          COVERAGE=$(grep -oP 'TOTAL.*\K\d+%' coverage_output.txt || echo "N/A")
          echo "| Metric | Result | Standard | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Coverage | $COVERAGE | â‰¥ 80% | âœ… |" >> $GITHUB_STEP_SUMMARY

          # Parse Pylint score
          PYLINT_SCORE=$(grep -oP 'rated at \K[0-9.]+' pylint_output.txt || echo "N/A")
          echo "| Code Quality | ${PYLINT_SCORE}/10 | â‰¥ 8.0 | âœ… |" >> $GITHUB_STEP_SUMMARY

          # Parse average complexity
          AVG_COMPLEXITY=$(grep -oP 'Average complexity: \K[A-F] \([0-9.]+\)' radon_output.txt || echo "N/A")
          echo "| Avg Complexity | $AVG_COMPLEXITY | â‰¤ 15 | âœ… |" >> $GITHUB_STEP_SUMMARY

          # Parse Bandit issues
          BANDIT_ISSUES=$(grep -oP 'Total issues \(severity\): \K\d+' bandit_output.txt || echo "0")
          echo "| Security Issues | $BANDIT_ISSUES critical | 0 | âœ… |" >> $GITHUB_STEP_SUMMARY

          # Check for duplication
          if grep -q "duplicate-code" duplication_output.txt; then
            echo "| Code Duplication | Detected | None | âš ï¸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Code Duplication | None | None | âœ… |" >> $GITHUB_STEP_SUMMARY
          fi

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: quality-gate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker Image for Testing
        run: docker build --target test -t mindsync-screening-test .

      - name: Run tests
        run: docker run --rm mindsync-screening-test

  build_and_push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: test
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
